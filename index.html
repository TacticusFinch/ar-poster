<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Magic Chess Poster</title>

<meta name="viewport" content="width=device-width,initial-scale=1, user-scalable=no,viewport-fit=cover">

<!-- A-Frame + MindAR ------------------------------------------------------->
<script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.4/dist/mindar-image-aframe.prod.js"></script>

<style>
html,body{margin:0;padding:0;width:100%;height:100%;font-family:Trebuchet MS, sans-serif;}
#app,a-scene{width:100%;height:100%;}

/* --- Камера MindAR и канвас на весь экран -------------------------------- */
#mindar-image-video{
  position:fixed !important;
  top:0;left:0;width:100vw;height:100vh;
  object-fit:cover;
  z-index:-2;
}
a-scene canvas{
  position:fixed !important;
  top:0;left:0;width:100vw !important;height:100vh !important;
}
/* ------------------------------------------------------------------------- */

/* --- Кнопки -------------------------------------------------------------- */
#buttons{
  position:fixed;
  transform:translate(-50%,-50%);
  display:flex;flex-direction:column;gap:16px;align-items:center;
  opacity:0;pointer-events:none;
  transition:opacity .6s ease;
  z-index:10;
}
#buttons.show{opacity:1;pointer-events:auto;}

#buttons a{
  --glow1:#00e0ff;
  --glow2:#a200ff;

  color:#fff;text-decoration:none;
  font-weight:700;font-size:1rem;         /* базовый (масштабируется JS-ом) */
  letter-spacing:.4px;
  padding:12px 42px;border-radius:12px;
  background:linear-gradient(135deg,var(--glow1) 0%,var(--glow2) 100%);
  box-shadow:0 0 10px var(--glow1),0 0 20px var(--glow2);
  transition:transform .18s cubic-bezier(.3,1.5,.5,1),
             box-shadow .25s,
             filter .25s;
}
#buttons a:hover{
  transform:scale(1.06);
  box-shadow:0 0 16px var(--glow1),0 0 32px var(--glow2),0 0 52px rgba(255,255,255,.4);
  filter:brightness(1.15) saturate(1.3);
}
#buttons a:active{transform:scale(.95);}
/* ------------------------------------------------------------------------- */
</style>
</head>

<body>
<div id="app">

  <a-scene
    mindar-image="imageTargetSrc: targets.mind; uiScanning: false; uiLoading: false;"
    color-space="sRGB" embedded
    renderer="colorManagement:true,physicallyCorrectLights"
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:false">

    <a-assets>
      <video id="wizard" src="wizard.mp4" preload="auto" crossorigin="anonymous"></video>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

    <!-- anchor с видео и компонентом ui-follow -->
    <a-entity mindar-image-target="targetIndex:0"
              ui-follow="ui:#buttons; offsetY:90; baseWidth:350">
      <a-video src="#wizard" width="1" height="0.5625" position="0 0 0"
               autoplay="false" loop="false"></a-video>
    </a-entity>
  </a-scene>

  <!-- UI-кнопки -->
  <div id="buttons">
    <a id="play" href="https://lichess.org/ru/learn" target="_blank" rel="noopener">Играть</a>
    <a id="sign" href="https://t.me/Gyatzo" target="_blank" rel="noopener">Записаться</a>
  </div>

</div>

<script>
/* --------------------------------------------------------------------------
   Компонент ui-follow:
   – проецирует центр якоря в экранные координаты
   – подгоняет масштаб UI-блока под ширину плоскости в кадре
-------------------------------------------------------------------------- */
AFRAME.registerComponent('ui-follow', {
  schema: {
    ui:        {type: 'selector'}, // HTML-блок
    offsetY:   {type: 'number', default: 0},
    baseWidth: {type: 'number', default: 260} // px → при таком размере scale = 1
  },
  init() {
    this.uiEl      = this.data.ui;
    this.offsetY   = this.data.offsetY;
    this.baseWidth = this.data.baseWidth;
    this.visible   = false;

    this.leftVec   = new THREE.Vector3(-0.5, 0, 0); // левый край плоскости (width = 1)
    this.rightVec  = new THREE.Vector3( 0.5, 0, 0); // правый край

    this.el.addEventListener('targetFound', () => { this.visible = true;  });
    this.el.addEventListener('targetLost',  () => { this.visible = false; });
  },
  tick() {
    if (!this.visible) return;
    const camera = this.el.sceneEl.camera;
    if (!camera) return;

    /* --- положение центра ------------------------------------------------ */
    const worldPos = new THREE.Vector3();
    this.el.object3D.getWorldPosition(worldPos);
    worldPos.project(camera);

    const x = ( worldPos.x + 1) / 2 * window.innerWidth;
    const y = (-worldPos.y + 1) / 2 * window.innerHeight + this.offsetY;

    /* --- ширина плоскости в пикселях ------------------------------------ */
    const leftW  = this.leftVec.clone().applyMatrix4(this.el.object3D.matrixWorld);
    const rightW = this.rightVec.clone().applyMatrix4(this.el.object3D.matrixWorld);
    leftW.project(camera);
    rightW.project(camera);

    const widthNDC = Math.abs(rightW.x - leftW.x);          // от 0 до 2
    const posterPx = widthNDC * 0.5 * window.innerWidth;     // → px

    /* --- масштаб кнопок -------------------------------------------------- */
    const scale = posterPx / this.baseWidth;                // относительный
    this.uiEl.style.left      = `${x}px`;
    this.uiEl.style.top       = `${y}px`;
    this.uiEl.style.transform = `translate(-50%,-50%) scale(${scale})`;
  }
});

/* --------------------------------------------------------------------------
   Подгоняем плоскость под нужное соотношение сторон видео,
   запускаем ролик, показываем кнопки после окончания видео.
-------------------------------------------------------------------------- */
document.addEventListener("DOMContentLoaded", () => {

  const scene  = document.querySelector("a-scene");
  const video  = document.querySelector("#wizard");
  const anchor = document.querySelector("[mindar-image-target]");
  const ui     = document.querySelector("#buttons");
  const plane  = anchor.querySelector("a-video");

  /* корректное соотношение сторон плоскости */
  video.addEventListener("loadedmetadata", () => {
    const ratio = video.videoHeight / video.videoWidth; // h / w
    plane.setAttribute("width", 1);
    plane.setAttribute("height", ratio);
  });

  /* камере – режим object-fit:cover */
  scene.addEventListener("renderstart", () => {
    const camVideo = document.querySelector("#mindar-image-video");
    if (camVideo) camVideo.style.objectFit = "cover";
  });

  /* запускаем ролик с небольшой задержкой после захвата маркера */
  anchor.addEventListener("targetFound", () => setTimeout(() => video.play(), 500));

  /* показываем UI после окончания видео */
  video.addEventListener("ended", () => ui.classList.add("show"));
});
</script>
</body>
</html>
