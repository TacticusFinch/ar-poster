<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Живой Постер - Шахматная Школа</title>
    <style>
        /* Убираем все отступы и делаем так, чтобы контент занимал весь экран */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        /* Контейнер для видео и холста */
        #container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Видео с камеры и холст для эффектов будут наложены друг на друга */
        #video, #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* Видео будет заполнять весь экран без искажений */
        }

        /* Холст должен быть поверх видео */
        #canvas {
            z-index: 10;
        }

        /* Информационное сообщение для пользователя */
        #info {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            z-index: 20;
            text-align: center;
            font-size: 16px;
        }
    </style>
</head>
<body>

    <div id="container">
        <!-- Элемент для отображения видео с камеры -->
        <video id="video" playsinline autoplay muted></video>
        <!-- Холст (canvas) для рисования эффектов поверх видео -->
        <canvas id="canvas"></canvas>
    </div>

    <!-- Информационное сообщение для пользователя -->
    <div id="info">Запускаем камеру...</div>

    <script>
        // Получаем доступ к элементам на странице
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const info = document.getElementById('info');

        // Определяем наши цели: текст и соответствующие ссылки
        const targets = {
            'играть': 'https://lichess.org/ru/learn',
            'записаться': 'https://t.me/m/s_Zqu21RY2Yy'
        };

        // Массив для хранения активных, подсвеченных областей
        let activeTargets = [];

        // 1. Проверяем, поддерживает ли браузер распознавание текста
        if (!('TextDetector' in window)) {
            info.innerHTML = 'К сожалению, ваш браузер не поддерживает распознавание текста. <br>Попробуйте Google Chrome на Android.';
        } else {
            // 2. Если поддержка есть, инициализируем детектор текста
            const textDetector = new TextDetector();
            startCamera();
        }

        // 3. Функция для запуска камеры
        async function startCamera() {
            try {
                // Запрашиваем доступ к задней камере ('environment')
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' },
                    audio: false
                });

                // Передаем видеопоток в наш <video> элемент
                video.srcObject = stream;

                // Как только видео загрузится, начнем обработку
                video.onloadedmetadata = () => {
                    info.textContent = 'Наведите камеру на постер';
                    // Устанавливаем размеры холста такими же, как у видео
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    // Запускаем бесконечный цикл распознавания
                    detectLoop();
                };

            } catch (err) {
                console.error("Ошибка доступа к камере: ", err);
                info.textContent = 'Не удалось получить доступ к камере. Пожалуйста, разрешите его.';
            }
        }

        // 4. Основной цикл распознавания и отрисовки
        async function detectLoop() {
            try {
                // Распознаем текст на текущем кадре видео
                const detectedTexts = await textDetector.detect(video);
                
                // Очищаем холст перед новой отрисовкой
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                activeTargets = []; // Сбрасываем активные цели

                if (detectedTexts.length > 0) {
                    detectedTexts.forEach(text => {
                        const detectedWord = text.rawValue.toLowerCase().trim();
                        
                        // Проверяем, есть ли распознанное слово в наших целях
                        if (targets[detectedWord]) {
                            const boundingBox = text.boundingBox;
                            
                            // Сохраняем активную цель для обработки кликов
                            activeTargets.push({
                                word: detectedWord,
                                box: boundingBox,
                                url: targets[detectedWord]
                            });

                            // Рисуем красивый эффект подсветки
                            drawHighlight(boundingBox);
                        }
                    });
                }
            } catch (err) {
                console.error("Ошибка при распознавании текста:", err);
            }

            // Запрашиваем следующий кадр для анимации
            requestAnimationFrame(detectLoop);
        }

        // 5. Функция для отрисовки эффекта подсветки
        function drawHighlight(box) {
            // Настройки эффекта свечения
            ctx.shadowColor = '#00f6ff'; // Цвет свечения (голубой, как магия)
            ctx.shadowBlur = 20; // Сила размытия свечения

            // Настройки полупрозрачного прямоугольника
            ctx.fillStyle = 'rgba(0, 246, 255, 0.3)'; // Цвет заливки
            ctx.strokeStyle = 'rgba(0, 246, 255, 0.8)'; // Цвет обводки
            ctx.lineWidth = 3;

            // Рисуем прямоугольник по координатам, полученным от детектора
            ctx.beginPath();
            ctx.rect(box.x, box.y, box.width, box.height);
            ctx.fill();
            ctx.stroke();

            // Сбрасываем тень, чтобы она не применялась к другим элементам
            ctx.shadowBlur = 0;
        }

        // 6. Обработка кликов по холсту (canvas)
        canvas.addEventListener('click', (event) => {
            // Получаем координаты клика относительно холста
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (event.clientX - rect.left) * scaleX;
            const y = (event.clientY - rect.top) * scaleY;

            // Проверяем, попал ли клик в одну из активных областей
            for (const target of activeTargets) {
                const box = target.box;
                if (x >= box.x && x <= box.x + box.width && y >= box.y && y <= box.y + box.height) {
                    info.textContent = `Переходим по ссылке для "${target.word}"...`;
                    // Перенаправляем пользователя по нужной ссылке
                    window.location.href = target.url;
                    return; // Выходим из цикла после первого совпадения
                }
            }
        });
    </script>
</body>
</html>