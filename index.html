<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Wizard Poster</title>

    <!-- Подключаем легкую и быструю библиотеку MindAR -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image.prod.js"></script>
    <!-- Подключаем Three.js, который является зависимостью для MindAR -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.min.js"></script>
    <!-- Подключаем контроллер MindAR для Three.js -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"></script>

    <style>
        /* Убираем отступы и скрываем скролл, чтобы AR-сцена занимала весь экран */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
        }

        /* Контейнер для AR-сцены */
        #ar-container {
            width: 100%;
            height: 100%;
            position: relative;
            display: block;
        }

        /* Стили для кнопок, которые будут накладываться поверх постера */
        .action-button {
            /* Изначально скрыты */
            display: none; 
            position: absolute;
            background-color: rgba(0, 0, 0, 0); /* Прозрачный фон, чтобы были видны кнопки на постере */
            border: 2px solid rgba(255, 255, 255, 0); /* Прозрачная рамка */
            cursor: pointer;
            z-index: 100; /* Поверх всего */
            
            /* Центрирование относительно заданной точки */
            transform: translate(-50%, -50%); 
        }

        /* Позиционирование кнопки "Играть" */
        #play-button {
            /* 
             * Располагаем по центру постера по горизонтали (left: 50%).
             * Располагаем на 65% от верха постера. 
             * Подбери эти значения, если кнопки на постере находятся в других местах.
            */
            top: 65%;
            left: 50%;
            width: 60%; /* Ширина кликабельной области */
            height: 15%; /* Высота кликабельной области */
        }

        /* Позиционирование кнопки "Записаться" */
        #signup-button {
            /* Располагаем ниже кнопки "Играть" */
            top: 85%;
            left: 50%;
            width: 60%;
            height: 15%;
        }
    </style>
</head>
<body>
    <!-- Контейнер, куда MindAR будет рендерить сцену -->
    <div id="ar-container">
        <!-- Кликабельные зоны, которые будут активированы после видео -->
        <div id="play-button" class="action-button"></div>
        <div id="signup-button" class="action-button"></div>
    </div>
    
    <!-- 
        Видео-элемент. Важные атрибуты:
        - muted: Обязательно для автопроигрывания в большинстве мобильных браузеров.
        - playsinline: Предотвращает разворачивание видео на весь экран на iOS.
        - preload="auto": Начинает загрузку видео как можно раньше.
        - style="display: none;": Видео не должно отображаться как обычный HTML-элемент.
    -->
    <video id="wizard-video" src="./wizard.mp4" muted playsinline preload="auto" style="display: none;"></video>

    <script>
        // Ждем полной загрузки DOM, чтобы все элементы были доступны
        document.addEventListener('DOMContentLoaded', async () => {
            // Получаем ссылки на DOM-элементы
            const video = document.querySelector("#wizard-video");
            const playButton = document.querySelector("#play-button");
            const signupButton = document.querySelector("#signup-button");

            // Инициализация MindAR
            const mindarThree = new MindAR.MindARThree({
                container: document.querySelector("#ar-container"),
                imageTargetSrc: './targets.mind', // Путь к твоему файлу с целями
                maxTrack: 1 // Отслеживаем только один постер за раз для лучшей производительности
            });

            // Деструктуризация для удобного доступа к рендереру, сцене и камере
            const { renderer, scene, camera } = mindarThree;

            // Создаем текстуру из нашего видео
            const videoTexture = new THREE.VideoTexture(video);
            // Создаем материал для плоскости, на которую наложим видео
            const videoMaterial = new THREE.MeshBasicMaterial({ map: videoTexture });
            // Создаем геометрию плоскости. Размер 1x1, т.к. MindAR автоматически масштабирует ее под размер постера
            const planeGeometry = new THREE.PlaneGeometry(1, 1);
            // Создаем сам объект (меш), который будет виден в AR
            const videoPlane = new THREE.Mesh(planeGeometry, videoMaterial);

            // Создаем "якорь" для нашей цели (постера). 0 - это индекс цели в файле targets.mind
            const anchor = mindarThree.addAnchor(0);
            // Добавляем плоскость с видео к якорю. Теперь она будет появляться и двигаться вместе с постером.
            anchor.group.add(videoPlane);
            
            // --- Логика событий ---

            // Событие: постер найден
            anchor.on('targetFound', () => {
                console.log("Target Found");
                videoPlane.visible = true; // Делаем плоскость с видео видимой
                video.muted = false; // Включаем звук (браузер разрешит это после взаимодействия пользователя с камерой)
                video.play();
            });

            // Событие: постер потерян из вида
            anchor.on('targetLost', () => {
                console.log("Target Lost");
                video.pause();
                video.currentTime = 0; // Сбрасываем видео на начало
                
                // Скрываем кнопки, если постер потерян
                playButton.style.display = 'none';
                signupButton.style.display = 'none';
            });

            // Событие: видео закончилось
            video.addEventListener('ended', () => {
                console.log("Video Ended");
                // Скрываем плоскость с видео, чтобы был виден оригинальный постер под ней
                videoPlane.visible = false;

                // Показываем наши прозрачные кликабельные кнопки
                playButton.style.display = 'block';
                signupButton.style.display = 'block';
            });
            
            // Обработчики нажатий на кнопки
            playButton.addEventListener('click', () => {
                window.location.href = 'https://lichess.org/ru/learn';
            });

            signupButton.addEventListener('click', () => {
                window.location.href = 'https://t.me/m/s_Zqu21RY2Yy';
            });

            // --- Старт AR-движка ---

            // Асинхронный запуск MindAR (запросит доступ к камере)
            await mindarThree.start();

            // Запускаем цикл рендеринга
            renderer.setAnimationLoop(() => {
                renderer.render(scene, camera);
            });
        });
    </script>
</body>
</html>
